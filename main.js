var C=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var B=(n,e)=>{for(var t in e)C(n,t,{get:e[t],enumerable:!0})},_=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of U(e))!I.call(n,s)&&s!==t&&C(n,s,{get:()=>e[s],enumerable:!(i=z(e,s))||i.enumerable});return n};var q=n=>_(C({},"__esModule",{value:!0}),n);var W={};B(W,{default:()=>x});module.exports=q(W);var R=require("obsidian");var F=require("obsidian");var g=require("@codemirror/state"),v=require("@codemirror/view"),H=require("obsidian");function f(n){return n.dom.ownerDocument.querySelector(".workspace-leaf.mod-active .cm-editor, .mod-inside-iframe .cm-editor")}function A(n){return n.dom.ownerDocument.querySelector(".workspace-leaf.mod-active .cm-scroller, .mod-inside-iframe .cm-scroller")}function E(n){return n.dom.ownerDocument.querySelector(".workspace-leaf.mod-active .cm-sizer, .mod-inside-iframe .cm-sizer")}var m=class{constructor(e,t){this.lib=e,this.view=t}getActiveLineProp(e){var i;let t=(i=this.view.contentDOM.querySelector(".cm-active.cm-line"))==null?void 0:i.getCssPropertyValue(e).replace("px","");return t?Number.parseFloat(t):null}getActiveLineOffset(e){let t=e.top,i=f(this.view);if(!i)return 0;let s=i.getBoundingClientRect().top;return t-s}getTypewriterOffset(){let e=f(this.view);return e?e.clientHeight*this.lib.settings.typewriter.offset:0}getPositionData(){let e=this.view.coordsAtPos(this.view.state.selection.main.head);if(!e)return null;let t=e.bottom-e.top,i=this.getActiveLineProp("line-height");if(!i)return null;let s,r;t>i?(s=t,r=0):(s=i,r=(s-t)/2);let d=this.getTypewriterOffset(),u=this.getActiveLineOffset(e),p=f(this.view),c=A(this.view),l;return p&&c?this.lib.settings.typewriter.enabled?(l=d,u<0?l=0:l=c.scrollTop+u<d?Math.min(d,u):d):l=u:l=0,{typewriterOffset:d,scrollOffset:l,activeLineOffset:u,lineHeight:s,lineOffset:r}}};var T=require("@codemirror/view");var o={enabled:"focused-writing-enabled",hideRibbon:"focused-writing--hide-ribbon",hideTabs:"focused-writing--hide-tabs",hideStatusBar:"focused-writing--hide-status-bar",hideFileHeader:"focused-writing--hide-file-header",hideTitle:"focused-writing--hide-title",hideSideDockLeft:"focused-writing--hide-side-dock-left",hideSideDockRight:"focused-writing--hide-side-dock-right",maxChars:"focused-writing--max-chars",uniformText:"focused-writing--uniform-text",activeSentence:"focused-writing-active-sentence",inactive:"focused-writing-inactive"},h={dimmedOpacity:"--focused-writing-dimmed-opacity",fontSize:"--focused-writing-font-size",fontFamily:"--focused-writing-font-family",maxChars:"--focused-writing-max-chars",typewriterOffset:"--focused-writing-typewriter-offset"},b={sentenceDelimiters:".!?",extraCharacters:`*"'`,ignoredPatterns:`Mr.
Mrs.
Dr.
Ms.
Prof.
e.g.
i.e.`};function L(n,e,t){for(let i of e)if(n.slice(t+1-i.length,t+1)===i)return!0;return!1}function k(n,e){let t=b.sentenceDelimiters.split(""),i=b.extraCharacters.split(""),s=b.ignoredPatterns.split(`
`),r=n.from,d=n.text,u=-1;for(let c=e-r-1;c>=0;c--)if(t.includes(d[c])){if(L(d,s,c))continue;let l=1;for(;d[c+l]===" "&&l<e-r-1;)l+=1;for(;i.includes(d[c+l])&&t.includes(d[c+l-1])&&l<e-r-1;)l+=1;u=c+l;break}u===-1&&(u=0);let p=-1;for(let c=e-r;c<n.length;c++)if(t.includes(d[c])){if(L(d,s,c))continue;let l=1;for(;t.includes(d[c+l])&&l<n.length;)l+=1;for(;i.includes(d[c+l])&&l<n.length;)l+=1;p=c+l;break}return p!==-1?{start:u+r,end:p+r}:{start:u+r,end:null}}function P(n){var c;let e=[],i=n.state.selection.main.from,s=n.state.doc.lineAt(i),r=k(s,i);r.end===null&&i>s.from&&(r=k(s,i-1));let d=r.start,u=(c=r.end)!=null?c:s.to;function p(l,M,N){l>=M||e.push(T.Decoration.mark({inclusive:!0,attributes:{},class:N}).range(l,M))}return d!==u&&(p(d,u,o.activeSentence),s.from!==d&&p(s.from,d,o.inactive),u!==s.to&&p(u,s.to,o.inactive)),T.Decoration.set(e,!0)}var $=/^(select|input|delete|undo|redo)(\..+)?$/,G=/^(select.pointer)$/,D=class{constructor(e,t){this.resizeObserver=null;this.decorations=g.RangeSet.empty;this.lib=e,this.view=t,this.onLoad()}destroy(){var e;(e=this.resizeObserver)==null||e.disconnect(),this.resetPadding()}onLoad(){this.resizeObserver=new ResizeObserver(()=>this.onResize()),this.resizeObserver.observe(this.view.dom.ownerDocument.body),this.onReconfigured()}isActive(){return this.lib.settings.enabled&&this.isMarkdownFile()}isMarkdownFile(){let e=this.lib.app.workspace.getActiveViewOfType(H.ItemView);return(e==null?void 0:e.getViewType())==="markdown"}isTableCell(){var e,t,i;return(i=(t=(e=this.view.dom.parentElement)==null?void 0:e.parentElement)==null?void 0:t.className.includes("table-cell-wrapper"))!=null?i:!1}userEventAllowed(e){return $.test(e)&&!G.test(e)}inspectTransactions(e){let t=[],i=!1;for(let r of e.transactions){r.reconfigured&&(i=!0);let d=r.annotation(g.Transaction.userEvent);d!==void 0&&t.push(d)}if(t.length===0)return{isReconfigured:i,isUserEvent:!1,allowedUserEvents:!1};let s=t.every(r=>this.userEventAllowed(r));return{isReconfigured:i,isUserEvent:!0,allowedUserEvents:s}}update(e){let{isReconfigured:t,isUserEvent:i,allowedUserEvents:s}=this.inspectTransactions(e);if(!this.isTableCell()&&(t&&this.onReconfigured(),!!this.isActive())){if(!i){this.applyDecorations();return}s?this.updateAllowedUserEvent():this.applyDecorations()}}onReconfigured(){if(!this.isActive()){this.resetPadding(),this.decorations=g.RangeSet.empty;return}this.updateAfterExternalEvent()}onResize(){this.isActive()&&this.updateAfterExternalEvent()}updateAllowedUserEvent(){this.applyDecorations(),this.measurePosition("FocusModeAllowedUserEvent",e=>{this.recenterAndApply(e)})}updateAfterExternalEvent(){this.applyDecorations(),this.measurePosition("FocusModeExternalEvent",e=>{this.lib.settings.typewriter.enabled&&this.setPadding(e.typewriterOffset),this.recenterAndApply(e)})}applyDecorations(){if(!this.lib.settings.sentenceFade.enabled){this.decorations=g.RangeSet.empty;return}this.decorations=P(this.view)}measurePosition(e,t){this.view.requestMeasure({key:e,read:()=>new m(this.lib,this.view).getPositionData(),write:i=>{i&&window.requestAnimationFrame(()=>t(i))}})}recenterAndApply(e){this.lib.settings.typewriter.enabled&&this.recenter(e.scrollOffset)}recenter(e){let t=this.view.state.selection.main.head,i=v.EditorView.scrollIntoView(t,{y:"start",yMargin:e});this.view.dispatch(this.view.state.update({effects:i}))}setPadding(e){let t=E(this.view);t&&(t.style.padding=`0 0 ${e}px 0`)}resetPadding(){let e=E(this.view);e&&e.style.removeProperty("padding")}};function O(n){return v.ViewPlugin.define(e=>new D(n,e),{decorations:e=>e.decorations})}var S=class{constructor(e){this.plugin=e}apply(){let{ui:e}=this.plugin.settings,t=document.body;e.hideRibbon&&t.addClass(o.hideRibbon),e.hideTabs&&t.addClass(o.hideTabs),e.hideStatusBar&&t.addClass(o.hideStatusBar),e.hideFileHeader&&t.addClass(o.hideFileHeader),e.hideTitle&&t.addClass(o.hideTitle),e.hideSideDockLeft&&t.addClass(o.hideSideDockLeft),e.hideSideDockRight&&t.addClass(o.hideSideDockRight)}remove(){let e=document.body;e.removeClass(o.hideRibbon),e.removeClass(o.hideTabs),e.removeClass(o.hideStatusBar),e.removeClass(o.hideFileHeader),e.removeClass(o.hideTitle),e.removeClass(o.hideSideDockLeft),e.removeClass(o.hideSideDockRight)}refresh(){this.remove(),this.plugin.settings.enabled&&this.apply()}};var w=class{constructor(e){this.editorExtensions=[];this.previousEditorMode=null;this.cssVariables={};this.plugin=e,this.uiHider=new S(e)}get settings(){return this.plugin.settings}get app(){return this.plugin.app}initialize(){this.editorExtensions=[O(this)],this.plugin.registerEditorExtension(this.editorExtensions),this.updateCSSVariables(),this.settings.enabled&&this.activate()}toggle(){this.plugin.settings.enabled=!this.plugin.settings.enabled,this.plugin.settings.enabled?this.activate():this.deactivate(),this.plugin.saveSettings(),this.plugin.app.workspace.updateOptions()}activate(){var t,i;let e=document.body;e.addClass(o.enabled),e.addClass(o.maxChars),this.settings.textScaling.uniformTextSize&&e.addClass(o.uniformText),this.uiHider.apply(),this.applyCSSVariables(),this.settings.ui.fullScreen&&((i=(t=document.body).requestFullscreen)==null||i.call(t)),this.settings.editor.useSourceMode&&this.enableSourceMode()}deactivate(){var t;let e=document.body;e.removeClass(o.enabled),e.removeClass(o.maxChars),e.removeClass(o.uniformText),this.uiHider.remove(),this.removeCSSVariables(),document.fullscreenElement&&((t=document.exitFullscreen)==null||t.call(document)),this.settings.editor.useSourceMode&&this.restoreEditorMode()}enableSourceMode(){let e=this.app.workspace.getActiveViewOfType(F.MarkdownView);if(e){let t=e.getState();this.previousEditorMode=t.source?"source":"preview",t.source||e.leaf.setViewState({type:"markdown",state:{...t,mode:"source",source:!0}})}}restoreEditorMode(){let e=this.app.workspace.getActiveViewOfType(F.MarkdownView);if(e&&this.previousEditorMode==="preview"){let t=e.getState();e.leaf.setViewState({type:"markdown",state:{...t,mode:"source",source:!1}})}this.previousEditorMode=null}cleanup(){this.deactivate()}updateCSSVariables(){let{sentenceFade:e,textScaling:t,typewriter:i,maxChars:s}=this.settings,r=t.fontFamily.trim()||"Menlo, monospace";this.cssVariables={[h.dimmedOpacity]:String(e.opacity),[h.fontSize]:`${t.fontSize}px`,[h.fontFamily]:r,[h.maxChars]:`${s.maxChars}ch`,[h.typewriterOffset]:String(i.offset)},this.settings.enabled&&(this.applyCSSVariables(),this.refreshClasses())}applyCSSVariables(){for(let[e,t]of Object.entries(this.cssVariables))document.body.style.setProperty(e,t)}removeCSSVariables(){for(let e of Object.keys(this.cssVariables))document.body.style.removeProperty(e)}refreshClasses(){let e=document.body;e.addClass(o.maxChars),this.settings.textScaling.uniformTextSize?e.addClass(o.uniformText):e.removeClass(o.uniformText)}setCSSVariable(e,t){this.cssVariables[e]=t,this.settings.enabled&&document.body.style.setProperty(e,t)}refreshUI(){this.uiHider.refresh()}};var a=require("obsidian");var y=class extends a.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h1",{text:"Focused Writing"}),new a.Setting(e).setName("UI Elements").setHeading(),new a.Setting(e).setName("Hide ribbon").setDesc("Hide the left application ribbon when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideRibbon).onChange(async i=>{var s;this.plugin.settings.ui.hideRibbon=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide tabs").setDesc("Hide the tab header bar when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideTabs).onChange(async i=>{var s;this.plugin.settings.ui.hideTabs=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide status bar").setDesc("Hide the bottom status bar when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideStatusBar).onChange(async i=>{var s;this.plugin.settings.ui.hideStatusBar=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide file header").setDesc("Hide the file title header when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideFileHeader).onChange(async i=>{var s;this.plugin.settings.ui.hideFileHeader=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide title").setDesc("Hide the inline title at the top of documents when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideTitle).onChange(async i=>{var s;this.plugin.settings.ui.hideTitle=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide left sidebar").setDesc("Hide the left side dock when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideSideDockLeft).onChange(async i=>{var s;this.plugin.settings.ui.hideSideDockLeft=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Hide right sidebar").setDesc("Hide the right side dock when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.ui.hideSideDockRight).onChange(async i=>{var s;this.plugin.settings.ui.hideSideDockRight=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.refreshUI()})),new a.Setting(e).setName("Fullscreen").setDesc("Enter fullscreen when Focused Writing is activated (desktop only)").addToggle(t=>t.setValue(this.plugin.settings.ui.fullScreen).onChange(async i=>{this.plugin.settings.ui.fullScreen=i,await this.plugin.saveSettings()})),new a.Setting(e).setName("Editor").setHeading(),new a.Setting(e).setName("Use source mode").setDesc("Switch to source mode when Focused Writing is activated").addToggle(t=>t.setValue(this.plugin.settings.editor.useSourceMode).onChange(async i=>{this.plugin.settings.editor.useSourceMode=i,await this.plugin.saveSettings()})),new a.Setting(e).setName("Typewriter").setHeading(),new a.Setting(e).setName("Enable typewriter scrolling").setDesc("Keep the cursor vertically centered on screen while typing").addToggle(t=>t.setValue(this.plugin.settings.typewriter.enabled).onChange(async i=>{this.plugin.settings.typewriter.enabled=i,await this.plugin.saveSettings(),this.plugin.app.workspace.updateOptions()})),new a.Setting(e).setName("Typewriter position").setDesc("Vertical position of the active line (0% = top, 50% = center, 100% = bottom)").addSlider(t=>t.setLimits(0,100,5).setValue(this.plugin.settings.typewriter.offset*100).setDynamicTooltip().onChange(async i=>{var s;this.plugin.settings.typewriter.offset=i/100,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.updateCSSVariables(),this.plugin.app.workspace.updateOptions()})),new a.Setting(e).setName("Sentence Fading").setHeading(),new a.Setting(e).setName("Enable sentence fading").setDesc("Fade text outside the active sentence for better focus").addToggle(t=>t.setValue(this.plugin.settings.sentenceFade.enabled).onChange(async i=>{this.plugin.settings.sentenceFade.enabled=i,await this.plugin.saveSettings(),this.plugin.app.workspace.updateOptions()})),new a.Setting(e).setName("Inactive text opacity").setDesc("Visibility of faded text (0% = invisible, 100% = fully visible)").addSlider(t=>t.setLimits(0,100,5).setValue(this.plugin.settings.sentenceFade.opacity*100).setDynamicTooltip().onChange(async i=>{var s;this.plugin.settings.sentenceFade.opacity=i/100,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.setCSSVariable(h.dimmedOpacity,String(i/100))})),new a.Setting(e).setName("Text Styling").setHeading(),new a.Setting(e).setName("Enable dynamic text scaling").setDesc("Increase font size when Focused Writing is active").addToggle(t=>t.setValue(this.plugin.settings.textScaling.enabled).onChange(async i=>{var s;this.plugin.settings.textScaling.enabled=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.updateCSSVariables()})),new a.Setting(e).setName("Font size").setDesc("Font size in pixels when Focused Writing is active").addSlider(t=>t.setLimits(16,72,2).setValue(this.plugin.settings.textScaling.fontSize).setDynamicTooltip().onChange(async i=>{var s;this.plugin.settings.textScaling.fontSize=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.setCSSVariable(h.fontSize,`${i}px`)})),new a.Setting(e).setName("Font family").setDesc("Custom font family when Focused Writing is active (leave empty for system default)").addText(t=>t.setPlaceholder("e.g., Georgia, serif").setValue(this.plugin.settings.textScaling.fontFamily).onChange(async i=>{var s;this.plugin.settings.textScaling.fontFamily=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.updateCSSVariables()})),new a.Setting(e).setName("Uniform text size").setDesc("Make all text the same size (headers, title, etc. follow font size setting)").addToggle(t=>t.setValue(this.plugin.settings.textScaling.uniformTextSize).onChange(async i=>{var s;this.plugin.settings.textScaling.uniformTextSize=i,await this.plugin.saveSettings(),(s=this.plugin.lib)==null||s.updateCSSVariables()})),new a.Setting(e).setName("Line Width").setHeading(),new a.Setting(e).setName("Max characters per line").setDesc("Maximum number of characters per line for better readability").addText(t=>t.setPlaceholder("64").setValue(String(this.plugin.settings.maxChars.maxChars)).onChange(async i=>{var r;let s=parseInt(i,10);!isNaN(s)&&s>0&&(this.plugin.settings.maxChars.maxChars=s,await this.plugin.saveSettings(),(r=this.plugin.lib)==null||r.setCSSVariable(h.maxChars,`${s}ch`))}))}};var V={enabled:!1,ui:{hideRibbon:!0,hideTabs:!0,hideStatusBar:!0,hideFileHeader:!0,hideTitle:!0,hideSideDockLeft:!0,hideSideDockRight:!0,fullScreen:!1},typewriter:{enabled:!0,offset:.5},sentenceFade:{enabled:!0,opacity:.4},textScaling:{enabled:!0,fontSize:40,fontFamily:"Menlo",uniformTextSize:!0},maxChars:{maxChars:64},editor:{useSourceMode:!0}};var x=class extends R.Plugin{constructor(){super(...arguments);this.settings=V;this.lib=null}async onload(){await this.loadSettings(),this.lib=new w(this),this.lib.initialize(),this.addCommand({id:"toggle-focused-writing",name:"Toggle Focused Writing",hotkeys:[{modifiers:["Mod"],key:"u"}],callback:()=>{var t;return(t=this.lib)==null?void 0:t.toggle()}}),this.addSettingTab(new y(this.app,this))}onunload(){var t;(t=this.lib)==null||t.cleanup()}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},V,t)}async saveSettings(){await this.saveData(this.settings)}};
